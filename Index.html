<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Tactical System</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    
    // Icone Lucide come componenti semplici
    const MapPin = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>;
    const Users = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
    const Navigation = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>;
    const Crosshair = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>;
    const Menu = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>;
    const X = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
    const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
    const Trash2 = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
    const Download = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
    
    // Storage simulato per standalone
    if (!window.storage) {
      window.storage = {
        get: async (key) => {
          const val = localStorage.getItem(key);
          return val ? { value: val } : null;
        },
        set: async (key, value) => {
          localStorage.setItem(key, value);
          return { value };
        },
        delete: async (key) => {
          localStorage.removeItem(key);
          return { deleted: true };
        }
      };
    }

    const TacticalApp = () => {
      const [userLocation, setUserLocation] = useState(null);
      const [markers, setMarkers] = useState([]);
      const [showMenu, setShowMenu] = useState(false);
      const [coordFormat, setCoordFormat] = useState('mgrs');
      const [heading, setHeading] = useState(0);
      const [addingMarker, setAddingMarker] = useState(false);
      const [markerForm, setMarkerForm] = useState({ title: '', type: 'waypoint' });
      const [selectedMarker, setSelectedMarker] = useState(null);

      const markerTypes = {
        waypoint: { icon: '📍', label: 'Waypoint' },
        objective: { icon: '🎯', label: 'Obiettivo' },
        observation: { icon: '👁️', label: 'Osservazione' },
        hazard: { icon: '⚠️', label: 'Pericolo' }
      };

      useEffect(() => {
        const loadData = async () => {
          const data = await window.storage.get('tactical-data');
          if (data?.value) {
            const parsed = JSON.parse(data.value);
            setMarkers(parsed.markers || []);
          }
        };
        loadData();
      }, []);

      useEffect(() => {
        const saveData = async () => {
          await window.storage.set('tactical-data', JSON.stringify({ markers }));
        };
        const timer = setTimeout(saveData, 1000);
        return () => clearTimeout(timer);
      }, [markers]);

      useEffect(() => {
        if ('geolocation' in navigator) {
          const watchId = navigator.geolocation.watchPosition(
            (position) => {
              setUserLocation({
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
              });
            },
            null,
            { enableHighAccuracy: true }
          );
          return () => navigator.geolocation.clearWatch(watchId);
        }
      }, []);

      const formatMGRS = (lat, lng) => {
        const zone = Math.floor((lng + 180) / 6) + 1;
        return `${zone}T WF 1234 5678`;
      };

      const addMarker = () => {
        if (markerForm.title && userLocation) {
          setMarkers([...markers, {
            id: Date.now(),
            ...markerForm,
            lat: userLocation.lat,
            lng: userLocation.lng,
            timestamp: new Date().toISOString()
          }]);
          setMarkerForm({ title: '', type: 'waypoint' });
          setAddingMarker(false);
        }
      };

      return (
        <div className="h-screen w-screen bg-gray-900 text-white flex flex-col">
          <div className="bg-gray-800 border-b border-gray-700 p-3 flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Crosshair />
              <h1 className="text-lg font-bold">TACTICAL SYSTEM</h1>
            </div>
            <button onClick={() => setShowMenu(!showMenu)} className="p-2 hover:bg-gray-700 rounded">
              {showMenu ? <X /> : <Menu />}
            </button>
          </div>

          <div className="flex-1 relative overflow-hidden bg-gradient-to-br from-gray-700 to-gray-800">
            {userLocation && (
              <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
                <div className="w-4 h-4 bg-blue-500 rounded-full border-2 border-white animate-pulse"></div>
              </div>
            )}

            {markers.map((m, i) => (
              <div
                key={m.id}
                className="absolute text-2xl cursor-pointer"
                style={{ top: `${40 + i*10}%`, left: `${40 + i*8}%` }}
                onClick={() => setSelectedMarker(m)}
              >
                {markerTypes[m.type].icon}
              </div>
            ))}

            {userLocation && (
              <div className="absolute top-4 left-4 right-4 bg-gray-800 bg-opacity-95 rounded p-3">
                <div className="font-mono text-xs text-green-400">
                  {formatMGRS(userLocation.lat, userLocation.lng)}
                </div>
                <div className="text-xs text-gray-400 mt-1">
                  Precisione: ±{Math.round(userLocation.accuracy)}m
                </div>
              </div>
            )}

            {addingMarker && (
              <div className="absolute bottom-20 left-4 right-4 bg-gray-800 rounded p-4">
                <h3 className="font-bold mb-2">Nuovo Marker</h3>
                <input
                  type="text"
                  placeholder="Titolo"
                  value={markerForm.title}
                  onChange={(e) => setMarkerForm({...markerForm, title: e.target.value})}
                  className="w-full p-2 mb-2 bg-gray-700 rounded text-white"
                />
                <select
                  value={markerForm.type}
                  onChange={(e) => setMarkerForm({...markerForm, type: e.target.value})}
                  className="w-full p-2 mb-2 bg-gray-700 rounded text-white"
                >
                  {Object.entries(markerTypes).map(([k, v]) => (
                    <option key={k} value={k}>{v.icon} {v.label}</option>
                  ))}
                </select>
                <button
                  onClick={addMarker}
                  className="w-full p-2 bg-green-600 rounded"
                >
                  Aggiungi
                </button>
              </div>
            )}

            {selectedMarker && (
              <div className="absolute top-20 left-4 right-4 bg-gray-800 rounded p-4">
                <div className="flex justify-between mb-2">
                  <div className="font-bold">{selectedMarker.title}</div>
                  <button onClick={() => setSelectedMarker(null)}>
                    <X />
                  </button>
                </div>
                <div className="text-sm text-gray-400">
                  Tipo: {markerTypes[selectedMarker.type].label}
                </div>
              </div>
            )}
          </div>

          <div className="absolute bottom-20 right-4 flex flex-col gap-2">
            <button
              onClick={() => setAddingMarker(!addingMarker)}
              className={`p-3 rounded-full shadow-lg ${addingMarker ? 'bg-green-600' : 'bg-gray-700'}`}
            >
              <Plus />
            </button>
          </div>

          <div className="bg-gray-800 border-t border-gray-700 p-2 grid grid-cols-3 gap-1">
            <button className="p-3 rounded flex flex-col items-center">
              <MapPin />
              <span className="text-xs">Mappa</span>
            </button>
            <button className="p-3 rounded flex flex-col items-center">
              <Users />
              <span className="text-xs">Team</span>
            </button>
            <button onClick={() => setShowMenu(!showMenu)} className="p-3 rounded flex flex-col items-center">
              <Menu />
              <span className="text-xs">Menu</span>
            </button>
          </div>

          {showMenu && (
            <div className="absolute right-0 top-16 bottom-16 w-80 bg-gray-800 border-l border-gray-700 p-4 overflow-y-auto">
              <h2 className="font-bold mb-4">Markers ({markers.length})</h2>
              {markers.map(m => (
                <div key={m.id} className="bg-gray-700 p-3 rounded mb-2">
                  <div className="font-bold">{m.title}</div>
                  <button
                    onClick={() => {
                      setMarkers(markers.filter(x => x.id !== m.id));
                    }}
                    className="mt-2 p-1 bg-red-600 rounded text-xs w-full"
                  >
                    Elimina
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<TacticalApp />, document.getElementById('root'));
  </script>
</body>
</html>
