<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#111827">
  <title>Tactical System PRO</title>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body, html { margin:0; padding:0; width:100%; height:100%; font-family:system-ui, -apple-system; background:#111827; color:white; }
    #root { width:100%; height:100%; }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite; }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.5;} }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Storage helper
    const storage = {
      get: (key) => { try { const val = localStorage.getItem(key); return val ? JSON.parse(val) : null; } catch { return null; } },
      set: (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); return true; } catch { return false; } }
    };

    const TacticalApp = () => {
      const [userLocation, setUserLocation] = useState(null);
      const [markers, setMarkers] = useState([]);
      const [messages, setMessages] = useState([]);
      const [routes, setRoutes] = useState([]);
      const [areas, setAreas] = useState([]);
      const [breadcrumbs, setBreadcrumbs] = useState([]);
      const [teamMembers, setTeamMembers] = useState([]);

      const [showMenu, setShowMenu] = useState(false);
      const [showChat, setShowChat] = useState(false);
      const [showLayers, setShowLayers] = useState(false);
      const [selectedMarker, setSelectedMarker] = useState(null);
      const [addingMarker, setAddingMarker] = useState(false);
      const [measuringDistance, setMeasuringDistance] = useState(false);
      const [drawingArea, setDrawingArea] = useState(false);

      const [coordFormat, setCoordFormat] = useState('mgrs');
      const [datum, setDatum] = useState('wgs84');
      const [northReference, setNorthReference] = useState('true');
      const [azimuthFormat, setAzimuthFormat] = useState('mils');
      const [mapLayer, setMapLayer] = useState('topo');
      const [heading, setHeading] = useState(0);
      const [magneticDeclination, setMagneticDeclination] = useState(0);
      const [gridConvergence, setGridConvergence] = useState(0);
      const [isEncrypted, setIsEncrypted] = useState(true);

      const [markerForm, setMarkerForm] = useState({ title: '', description: '', type: 'waypoint' });
      const [chatMessage, setChatMessage] = useState('');
      const [measurePoints, setMeasurePoints] = useState([]);
      const [areaPoints, setAreaPoints] = useState([]);

      const [activeLayers, setActiveLayers] = useState({
        team: true,
        markers: true,
        routes: true,
        areas: true,
        breadcrumbs: true,
        rangeCircles: false
      });

      const [currentUser] = useState({ id: 'user_' + Date.now(), name: 'Operatore', callsign: 'ALPHA-1' });
      const watchIdRef = useRef(null);

      const markerTypes = {
        waypoint: { icon: 'üìç', label: 'Waypoint', color: '#3b82f6' },
        objective: { icon: 'üéØ', label: 'Obiettivo', color: '#ef4444' },
        observation: { icon: 'üëÅÔ∏è', label: 'Osservazione', color: '#10b981' },
        hazard: { icon: '‚ö†Ô∏è', label: 'Pericolo', color: '#f59e0b' },
        friendly: { icon: 'üîµ', label: 'Forze Amiche', color: '#06b6d4' },
        hostile: { icon: 'üî¥', label: 'Forze Ostili', color: '#dc2626' },
        unknown: { icon: '‚ùì', label: 'Sconosciuto', color: '#6b7280' },
        medic: { icon: 'üè•', label: 'Medico', color: '#ef4444' },
        supply: { icon: 'üì¶', label: 'Rifornimenti', color: '#8b5cf6' },
        lz: { icon: 'üöÅ', label: 'Landing Zone', color: '#22c55e' }
      };

      // Load saved data
      useEffect(() => {
        const data = storage.get('tactical-pro-data');
        if (data) {
          setMarkers(data.markers || []);
          setMessages(data.messages || []);
          setRoutes(data.routes || []);
          setAreas(data.areas || []);
          setBreadcrumbs(data.breadcrumbs || []);
        }
      }, []);

      // Save data
      useEffect(() => {
        storage.set('tactical-pro-data', { markers, messages, routes, areas, breadcrumbs });
      }, [markers, messages, routes, areas, breadcrumbs]);

      // GPS watch
      useEffect(() => {
        if ('geolocation' in navigator) {
          watchIdRef.current = navigator.geolocation.watchPosition(
            (position) => {
              const newLoc = { lat: position.coords.latitude, lng: position.coords.longitude, timestamp: Date.now() };
              setUserLocation(newLoc);
              if (position.coords.speed > 0.5) {
                setBreadcrumbs(prev => [...prev.slice(-100), newLoc]);
              }
            },
            (err) => console.error('GPS:', err),
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        }
        return () => { if (watchIdRef.current) navigator.geolocation.clearWatch(watchIdRef.current); };
      }, []);

      // Heading simulation
      useEffect(() => {
        const interval = setInterval(() => setHeading(prev => (prev + 5) % 360), 500);
        return () => clearInterval(interval);
      }, []);

      // Messaging
      const sendMessage = (text, type='user') => {
        const msg = { id: Date.now(), text, sender: type==='user'?currentUser.callsign:'SYSTEM', timestamp:new Date().toISOString(), type, encrypted:isEncrypted };
        setMessages([...messages, msg]);
      };
      const handleSendMessage = () => { if(chatMessage.trim()){ sendMessage(chatMessage); setChatMessage(''); }};

      return (
        <div className="h-screen w-screen flex flex-col bg-gray-900 text-white overflow-hidden">
          {/* Header */}
          <div className="bg-gray-800 p-2 flex justify-between items-center">
            <div className="font-bold text-lg">Tactical System PRO</div>
            <div>{currentUser.callsign} {isEncrypted && 'üîí'}</div>
          </div>

          {/* Map */}
          <div className="flex-1 relative bg-green-800">
            {/* User Marker */}
            {userLocation && (
              <div className="absolute w-4 h-4 bg-blue-500 rounded-full border-2 border-white animate-pulse"
                   style={{ top: `${userLocation.lat}%`, left: `${userLocation.lng}%`, transform: `translate(-50%,-50%) rotate(${heading}deg)` }}>
              </div>
            )}

            {/* Markers */}
            {activeLayers.markers && markers.map((m,i)=>(
              <div key={m.id} className="absolute text-2xl cursor-pointer"
                   style={{ top:`${35+(i*8)%40}%`, left:`${35+(i*10)%50}%`, transform:'translate(-50%,-50%)' }}
                   onClick={()=>setSelectedMarker(m)}>
                {markerTypes[m.type]?.icon || 'üìç'}
              </div>
            ))}

            {/* Breadcrumbs */}
            {activeLayers.breadcrumbs && breadcrumbs.map((p,i)=>(
              <div key={i} className="absolute w-1.5 h-1.5 bg-cyan-400 rounded-full opacity-50"
                   style={{ top:`${45+(i%10)*2}%`, left:`${45+(i%8)*2}%` }}></div>
            ))}
          </div>

          {/* Footer / quick info */}
          <div className="bg-gray-800 p-2 flex justify-between text-xs">
            <div>Markers: {markers.length}</div>
            <div>Aree: {areas.length}</div>
            <div>Msg: {messages.length}</div>
          </div>
        </div>
      );
    };

    // React 18 root
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TacticalApp />);
  </script>
</body>
</html>
