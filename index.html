<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactical Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
  html, body { height:100%; margin:0; }
  #map { width:100%; height:100%; }
  #menuIcon {
    position:absolute; top:10px; right:10px;
    width:40px; height:40px;
    background:#1f2937; color:white; border-radius:50%;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; z-index:1000;
  }
  #toolsMenu {
    position:absolute; top:60px; right:10px;
    background:rgba(31,41,55,0.95); color:white; padding:10px; border-radius:8px;
    display:none; z-index:1000;
  }
  #gpsButton {
    position:absolute; bottom:10px; right:10px;
    width:30px; height:30px; border-radius:50%;
    background:#3b82f6; display:flex; align-items:center; justify-content:center;
    color:white; cursor:pointer; z-index:1000;
  }
  #pointerCoords {
    position:absolute; bottom:10px; left:10px;
    background:rgba(31,41,55,0.8); color:white; padding:4px 8px; border-radius:4px;
    font-size:12px; z-index:1000;
  }
  #crosshair {
    position:absolute; top:50%; left:50%;
    width:20px; height:20px;
    margin-left:-10px; margin-top:-10px;
    border:2px solid red; border-radius:50%;
    z-index:1000; pointer-events:none;
  }
</style>
</head>
<body>

<div id="map"></div>

<!-- Men√π ridotto -->
<div id="menuIcon">‚ò∞</div>
<div id="toolsMenu">
  <button onclick="addMarkerPrompt()">Aggiungi Marker</button><br>
  <button onclick="startMeasure()">Misura Distanza</button><br>
  <button onclick="startDrawArea()">Disegna Area</button><br>
  <button onclick="chooseCoordFormat()">Formato Coordinate</button>
</div>

<!-- Pulsante GPS -->
<div id="gpsButton" title="Centra su di me">üìç</div>

<!-- Crocicchio e coordinate puntatore -->
<div id="crosshair"></div>
<div id="pointerCoords">-- , --</div>

<script>
// Inizializza mappa
const map = L.map('map').setView([45.0, 9.0], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

// Gestione menu
const menuIcon = document.getElementById('menuIcon');
const toolsMenu = document.getElementById('toolsMenu');
menuIcon.onclick = () => toolsMenu.style.display = toolsMenu.style.display === 'none' ? 'block' : 'none';

// Marker e area storage
let markers = [];
let areas = [];
let measurePoints = [];
let coordFormat = 'dd';

// Crocicchio coordinate
const pointerCoords = document.getElementById('pointerCoords');
map.on('move', () => {
  const c = map.getCenter();
  pointerCoords.innerText = formatCoords(c.lat, c.lng);
});

// Pulsante GPS
document.getElementById('gpsButton').onclick = () => {
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      map.setView([lat,lng], 17);
    });
  }
};

// Funzioni coordinate
function formatCoords(lat,lng){
  switch(coordFormat){
    case 'dd': return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    case 'dms': return toDMS(lat,lng);
    case 'dm': return toDM(lat,lng);
    default: return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  }
}
function toDMS(lat,lng){
  function conv(d, isLat){
    const dir = d>=0?(isLat?'N':'E'):(isLat?'S':'W');
    d=Math.abs(d);
    const deg=Math.floor(d);
    const min=Math.floor((d-deg)*60);
    const sec=((d-deg-min/60)*3600).toFixed(2);
    return `${deg}¬∞${min}'${sec}" ${dir}`;
  }
  return `${conv(lat,true)} ${conv(lng,false)}`;
}
function toDM(lat,lng){
  function conv(d,isLat){
    const dir=d>=0?(isLat?'N':'E'):(isLat?'S':'W');
    d=Math.abs(d);
    const deg=Math.floor(d);
    const min=((d-deg)*60).toFixed(4);
    return `${deg}¬∞${min}' ${dir}`;
  }
  return `${conv(lat,true)} ${conv(lng,false)}`;
}

// Tools
function addMarkerPrompt(){
  const title = prompt("Nome marker:");
  if(title && map.getCenter()){
    const c = map.getCenter();
    const marker = L.marker([c.lat,c.lng],{title}).addTo(map);
    markers.push(marker);
    alert(`Marker aggiunto: ${title}\n${formatCoords(c.lat,c.lng)}`);
  }
}
function startMeasure(){
  alert("Clicca sulla mappa per aggiungere punti di misura.");
  map.on('click', measureClick);
}
function measureClick(e){
  measurePoints.push(e.latlng);
  L.circleMarker(e.latlng,{color:'blue'}).addTo(map);
  if(measurePoints.length>=2){
    const d = map.distance(measurePoints[measurePoints.length-2],measurePoints[measurePoints.length-1]);
    alert(`Distanza segment: ${d.toFixed(2)} m`);
  }
}
function startDrawArea(){
  alert("Clicca sulla mappa per aggiungere punti area.");
  const areaPoints = [];
  const handler = (e)=>{
    areaPoints.push([e.latlng.lat,e.latlng.lng]);
    L.circleMarker(e.latlng,{color:'green'}).addTo(map);
    if(areaPoints.length>=3){
      const poly = L.polygon(areaPoints,{color:'green',fillOpacity:0.2}).addTo(map);
      areas.push(poly);
      map.off('click', handler);
      alert('Area creata!');
    }
  };
  map.on('click', handler);
}
function chooseCoordFormat(){
  const f = prompt("Formato coordinate (dd, dm, dms):",coordFormat);
  if(['dd','dm','dms'].includes(f)) coordFormat=f;
}
</script>
</body>
</html>
