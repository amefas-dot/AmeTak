<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#111827">
<title>Tactical System PRO</title>

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

<style>
  html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; font-family: system-ui, -apple-system; }
  #root { width:100%; height:100%; }
  .crosshair {
    position: absolute;
    left:50%;
    top:50%;
    transform: translate(-50%, -50%);
    width:24px;
    height:24px;
    border:2px solid red;
    border-radius:50%;
    pointer-events:none;
    z-index:50;
  }
</style>
</head>

<body>
<div id="root"></div>
<div class="crosshair"></div>

<script type="text/babel">

const { useState, useEffect, useRef } = React;

const TacticalApp = () => {
  const [map, setMap] = useState(null);
  const [userLocation, setUserLocation] = useState(null);
  const [markers, setMarkers] = useState([]);
  const [coordFormat, setCoordFormat] = useState('dd');
  const [points, setPoints] = useState([]);

  const mapRef = useRef(null);

  useEffect(() => {
    const m = L.map('root', { zoomControl: false }).setView([45, 12], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(m);
    setMap(m);
    mapRef.current = m;

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        const latlng = [pos.coords.latitude, pos.coords.longitude];
        setUserLocation(latlng);
      }, err => alert('GPS Error: ' + err.message), { enableHighAccuracy: true });
    }
  }, []);

  const formatCoordinates = (lat, lng) => {
    switch(coordFormat) {
      case 'dd': return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      case 'dms': return toDMS(lat,true)+', '+toDMS(lng,false);
      case 'utm': return toUTM(lat,lng);
      case 'mgrs': return toMGRS(lat,lng);
      default: return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
  };

  const toDMS = (deg, isLat) => {
    const abs = Math.abs(deg);
    const d = Math.floor(abs);
    const m = Math.floor((abs - d) * 60);
    const s = ((abs - d - m/60)*3600).toFixed(2);
    const dir = deg>=0 ? (isLat?'N':'E') : (isLat?'S':'W');
    return `${d}°${m}'${s}" ${dir}`;
  };

  const toUTM = (lat,lng) => { return `UTM ${lat.toFixed(4)}, ${lng.toFixed(4)}`; } // semplificato
  const toMGRS = (lat,lng) => { return `MGRS ${lat.toFixed(4)}, ${lng.toFixed(4)}`; } // semplificato

  const handleMapClick = (e) => {
    const { lat, lng } = e.latlng;
    const marker = L.marker([lat,lng], { draggable:true }).addTo(map);
    marker.bindPopup(`Coordinate: ${formatCoordinates(lat,lng)}`).openPopup();
    setMarkers([...markers, marker]);
    setPoints([...points, marker]);
  };

  useEffect(() => {
    if (!map) return;
    map.on('click', handleMapClick);
    return () => map.off('click', handleMapClick);
  }, [map, markers, coordFormat]);

  return (
    <div className="h-full w-full relative">
      {/* Menu strumenti */}
      <div className="absolute top-4 left-4 bg-gray-800 text-white p-2 rounded z-50 flex flex-col gap-2">
        <label className="text-sm">Formato coordinate:</label>
        <select value={coordFormat} onChange={e=>setCoordFormat(e.target.value)} className="bg-gray-700 p-1 rounded">
          <option value="dd">Decimali</option>
          <option value="dms">DMS</option>
          <option value="utm">UTM</option>
          <option value="mgrs">MGRS</option>
        </select>
        <button className="bg-blue-600 p-1 rounded" onClick={()=>points.forEach(m=>m.remove())}>Cancella Marker</button>
      </div>

      {/* Info box */}
      <div className="absolute bottom-4 left-4 bg-gray-800 text-white p-2 rounded shadow-lg z-50">
        Coordinate: {userLocation ? formatCoordinates(...userLocation) : '...' }
        <br/>
        {points.length>0 && userLocation && (
          <>
          Distanza dall’ultimo punto: {turf.distance([points[points.length-1].getLatLng().lng, points[points.length-1].getLatLng().lat], [userLocation[1],userLocation[0]], {units:'kilometers'}).toFixed(3)} km
          <br/>
          Direzione: {turf.bearing([points[points.length-1].getLatLng().lng, points[points.length-1].getLatLng().lat], [userLocation[1],userLocation[0]]).toFixed(1)}°
          </>
        )}
      </div>
    </div>
  );
};

ReactDOM.render(<TacticalApp />, document.getElementById('root'));

</script>
</body>
</html>
