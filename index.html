<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactical System PRO</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:system-ui, -apple-system; overflow:hidden; background:#111827; color:white; }
  #root { width:100vw; height:100vh; position:relative; }
  .menu { position:absolute; top:10px; left:10px; background:#1f2937; border:1px solid #374151; padding:10px; border-radius:8px; z-index:100; max-height:90vh; overflow-y:auto; }
  .menu button { width:100%; margin:2px 0; padding:6px; text-align:left; background:#374151; border:none; border-radius:4px; cursor:pointer; color:white; }
  .menu button:hover { background:#4b5563; }
  .marker { position:absolute; transform:translate(-50%, -50%); cursor:pointer; }
  .crosshair { position:absolute; top:50%; left:50%; width:20px; height:20px; transform:translate(-50%,-50%); border:2px solid cyan; border-radius:50%; z-index:90; pointer-events:none; }
  .popup { position:absolute; background:#1f2937; padding:5px; border:1px solid #4b5563; border-radius:4px; z-index:110; }
  .info-box { position:absolute; bottom:10px; left:10px; background:#1f2937; border:1px solid #374151; padding:8px; border-radius:8px; z-index:100; font-size:12px; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

// Storage helper
const storage = {
  get: key => { try { const val = localStorage.getItem(key); return val ? JSON.parse(val):null; } catch { return null; }},
  set: (key,value) => { try { localStorage.setItem(key, JSON.stringify(value)); return true; } catch { return false; }}
};

const markerTypes = {
  waypoint: {icon:'ğŸ“', color:'#3b82f6'},
  objective: {icon:'ğŸ¯', color:'#ef4444'},
  observation: {icon:'ğŸ‘ï¸', color:'#10b981'},
  hazard: {icon:'âš ï¸', color:'#f59e0b'},
  friendly: {icon:'ğŸ”µ', color:'#06b6d4'},
  hostile: {icon:'ğŸ”´', color:'#dc2626'},
  medic: {icon:'ğŸ¥', color:'#ef4444'},
  supply: {icon:'ğŸ“¦', color:'#8b5cf6'},
  lz: {icon:'ğŸš', color:'#22c55e'}
};

// Utility functions
function formatDD(lat,lng){ return `${lat.toFixed(6)}, ${lng.toFixed(6)}`; }
function formatDMS(lat,lng){
  const dms=(v,isLat)=>{
    const abs=Math.abs(v); const d=Math.floor(abs); const m=Math.floor((abs-d)*60); const s=(((abs-d)-m/60)*3600).toFixed(2);
    const dir=v>=0?(isLat?'N':'E'):(isLat?'S':'W'); return `${d}Â°${m}'${s}" ${dir}`;
  };
  return `${dms(lat,true)} ${dms(lng,false)}`;
}

function calculateDistance(lat1,lng1,lat2,lng2){
  const R=6371000; const Ï†1=lat1*Math.PI/180; const Ï†2=lat2*Math.PI/180;
  const Î”Ï†=(lat2-lat1)*Math.PI/180; const Î”Î»=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(Î”Ï†/2)**2+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function calculateBearing(lat1,lng1,lat2,lng2){
  const Ï†1=lat1*Math.PI/180; const Ï†2=lat2*Math.PI/180;
  const Î”Î»=(lng2-lng1)*Math.PI/180;
  const y=Math.sin(Î”Î»)*Math.cos(Ï†2); const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

function TacticalApp(){
  const [markers,setMarkers]=useState([]);
  const [showMenu,setShowMenu]=useState(true);
  const [crossCoords,setCrossCoords]=useState({lat:0,lng:0});
  const [coordFormat,setCoordFormat]=useState('dd');
  const [markerSize,setMarkerSize]=useState(32);
  const rootRef = useRef(null);

  useEffect(()=>{const data=storage.get('markers'); if(data) setMarkers(data);},[]);
  useEffect(()=>{storage.set('markers',markers);},[markers]);

  useEffect(()=>{
    const handleMove=e=>{
      const rect=rootRef.current.getBoundingClientRect();
      const x=(e.clientX-rect.left)/rect.width;
      const y=(e.clientY-rect.top)/rect.height;
      setCrossCoords({lat:(1-y)*180-90,lng:x*360-180});
    };
    const el=rootRef.current;
    el.addEventListener('mousemove',handleMove);
    el.addEventListener('touchmove',e=>handleMove(e.touches[0]));
    return ()=>{el.removeEventListener('mousemove',handleMove);}
  },[]);

  const addMarker = () => {
    const m={id:Date.now(), lat:crossCoords.lat, lng:crossCoords.lng, type:'waypoint'};
    setMarkers([...markers,m]);
  };

  const formatCoords = ({lat,lng})=>{
    switch(coordFormat){
      case 'dd': return formatDD(lat,lng);
      case 'dms': return formatDMS(lat,lng);
      default: return formatDD(lat,lng);
    }
  };

  return (
    <div id="root" ref={rootRef} className="w-full h-full relative">
      {/* Menu */}
      {showMenu && (
        <div className="menu">
          <button onClick={addMarker}>â• Aggiungi Marker</button>
          <button onClick={()=>setMarkerSize(markerSize+8)}>ğŸ” Ingrandisci Icone</button>
          <button onClick={()=>setMarkerSize(Math.max(8,markerSize-8))}>ğŸ” Riduci Icone</button>
          <button onClick={()=>setCoordFormat('dd')}>ğŸ“ Coordinate DD</button>
          <button onClick={()=>setCoordFormat('dms')}>ğŸ“ Coordinate DMS</button>
          <button onClick={()=>setMarkers([])}>ğŸ—‘ï¸ Cancella tutti i marker</button>
          <div className="mt-2 border-t border-gray-600 pt-2">
            <strong>Tools avanzati:</strong>
            <button onClick={()=>alert('Funzione misura distanza in sviluppo')}>ğŸ“ Misura distanza</button>
            <button onClick={()=>alert('Funzione azimut in sviluppo')}>ğŸ§­ Calcola direzione</button>
            <button onClick={()=>alert('Funzione area in sviluppo')}>ğŸ”· Disegna area</button>
          </div>
        </div>
      )}

      {/* Crosshair */}
      <div className="crosshair"></div>

      {/* Markers */}
      {markers.map(m=>(
        <div key={m.id} className="marker" style={{
          top:`${50-(crossCoords.lat/180*50)}%`,
          left:`${50+(crossCoords.lng/360*50)}%`,
          fontSize:`${markerSize}px`,
          color: markerTypes[m.type].color
        }}>
          {markerTypes[m.type].icon}
        </div>
      ))}

      {/* Info box */}
      <div className="info-box">
        <div><strong>Crosshair:</strong> {formatCoords(crossCoords)}</div>
        <div><strong>Markers:</strong> {markers.length}</div>
        <button onClick={()=>setShowMenu(!showMenu)} style={{marginTop:'5px',padding:'2px 4px',background:'#374151',borderRadius:'4px'}}>Toggle Menu</button>
      </div
