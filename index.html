<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#111827">
  <title>Tactical System PRO</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; font-family: system-ui, -apple-system; }
    #root { width: 100vw; height: 100vh; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const storage = {
      get: (key) => {
        try {
          const val = localStorage.getItem(key);
          return val ? JSON.parse(val) : null;
        } catch { return null; }
      },
      set: (key, value) => {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch {}
      }
    };

    const TacticalApp = () => {
      const [userLocation, setUserLocation] = useState(null);
      const [markers, setMarkers] = useState([]);
      const [messages, setMessages] = useState([]);
      const [routes, setRoutes] = useState([]);
      const [areas, setAreas] = useState([]);
      const [breadcrumbs, setBreadcrumbs] = useState([]);

      const [showMenu, setShowMenu] = useState(false);
      const [showChat, setShowChat] = useState(false);
      const [showLayers, setShowLayers] = useState(false);
      const [selectedMarker, setSelectedMarker] = useState(null);

      const [markerForm, setMarkerForm] = useState({ title: '', description: '', type: 'waypoint' });
      const [chatMessage, setChatMessage] = useState('');
      const [measurePoints, setMeasurePoints] = useState([]);
      const [areaPoints, setAreaPoints] = useState([]);

      const [coordFormat, setCoordFormat] = useState('mgrs');
      const [datum, setDatum] = useState('wgs84');
      const [northReference, setNorthReference] = useState('true');
      const [azimuthFormat, setAzimuthFormat] = useState('mils');
      const [mapLayer, setMapLayer] = useState('topo');
      const [heading, setHeading] = useState(0);
      const [magneticDeclination, setMagneticDeclination] = useState(0);
      const [gridConvergence, setGridConvergence] = useState(0);
      const [isEncrypted, setIsEncrypted] = useState(true);

      const [activeLayers, setActiveLayers] = useState({
        team: true,
        markers: true,
        routes: true,
        areas: true,
        breadcrumbs: true,
        rangeCircles: false
      });

      const [currentUser] = useState({
        id: 'user_' + Date.now(),
        name: 'Operatore',
        callsign: 'ALPHA-1'
      });

      const watchIdRef = useRef(null);

      const markerTypes = {
        waypoint: { icon: '📍', label: 'Waypoint', color: '#3b82f6' },
        objective: { icon: '🎯', label: 'Obiettivo', color: '#ef4444' },
        observation: { icon: '👁️', label: 'Osservazione', color: '#10b981' },
        hazard: { icon: '⚠️', label: 'Pericolo', color: '#f59e0b' },
        friendly: { icon: '🔵', label: 'Forze Amiche', color: '#06b6d4' },
        hostile: { icon: '🔴', label: 'Forze Ostili', color: '#dc2626' },
        unknown: { icon: '❓', label: 'Sconosciuto', color: '#6b7280' },
        medic: { icon: '🏥', label: 'Medico', color: '#ef4444' },
        supply: { icon: '📦', label: 'Rifornimenti', color: '#8b5cf6' },
        lz: { icon: '🚁', label: 'Landing Zone', color: '#22c55e' }
      };

      // Load data from storage
      useEffect(() => {
        const data = storage.get('tactical-pro-data');
        if (data) {
          setMarkers(data.markers || []);
          setMessages(data.messages || []);
          setRoutes(data.routes || []);
          setAreas(data.areas || []);
          setBreadcrumbs(data.breadcrumbs || []);
        }
      }, []);

      // Save data to storage
      useEffect(() => {
        storage.set('tactical-pro-data', { markers, messages, routes, areas, breadcrumbs });
      }, [markers, messages, routes, areas, breadcrumbs]);

      // GPS tracking
      useEffect(() => {
        if ('geolocation' in navigator) {
          watchIdRef.current = navigator.geolocation.watchPosition(
            (pos) => {
              const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
              setUserLocation(loc);
              setBreadcrumbs(prev => [...prev.slice(-99), loc]);
            },
            (err) => console.error('GPS error:', err),
            { enableHighAccuracy: true }
          );
        }
        return () => { if (watchIdRef.current) navigator.geolocation.clearWatch(watchIdRef.current); };
      }, []);

      // Orientation
      useEffect(() => {
        const handleOrientation = e => e.alpha !== null && setHeading(Math.round(e.alpha));
        if (window.DeviceOrientationEvent) {
          if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
              .then(state => state === 'granted' && window.addEventListener('deviceorientation', handleOrientation))
              .catch(console.error);
          } else window.addEventListener('deviceorientation', handleOrientation);
          return () => window.removeEventListener('deviceorientation', handleOrientation);
        }
      }, []);

      const sendMessage = (text, type = 'user') => {
        const msg = { id: Date.now(), text, sender: type==='user'?currentUser.callsign:'SYSTEM', timestamp: new Date().toISOString(), type, encrypted: isEncrypted };
        setMessages([...messages, msg]);
      };

      const addMarker = () => {
        if (markerForm.title.trim() && userLocation) {
          const m = { id: Date.now(), ...userLocation, ...markerForm, createdBy: currentUser.callsign, timestamp: new Date().toISOString() };
          setMarkers([...markers, m]);
          setMarkerForm({ title:'', description:'', type:'waypoint' });
          sendMessage(`📍 Marker aggiunto: ${m.title}`, 'system');
        }
      };

      return (
        <div className="h-screen w-screen bg-gray-900 text-white flex flex-col">
          {/* Header */}
          <div className="bg-gray-800 p-2 flex justify-between items-center border-b border-gray-700">
            <div className="flex items-center gap-2">
              <span className="text-green-500 text-xl">🎯</span>
              <div>
                <div className="text-sm font-bold">TACTICAL SYSTEM PRO</div>
                <div className="text-xs text-gray-400">{currentUser.callsign}</div>
              </div>
            </div>
            <div className="flex gap-2">
              {isEncrypted && <span className="text-green-500 text-xs">🔒</span>}
              <button onClick={()=>setShowChat(!showChat)} className="p-2 hover:bg-gray-700 rounded relative">
                <span className="text-lg">💬</span>
                {messages.length>0 && <span className="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>}
              </button>
              <button onClick={()=>setShowLayers(!showLayers)} className="p-2 hover:bg-gray-700 rounded">
                <span className="text-lg">📊</span>
              </button>
              <button onClick={()=>setShowMenu(!showMenu)} className="p-2 hover:bg-gray-700 rounded">
                <span className="text-lg">{showMenu?'✕':'☰'}</span>
              </button>
            </div>
          </div>

          {/* Map */}
          <div className="flex-1 relative">
            <div className="absolute inset-0 bg-gradient-to-br from-green-900 to-green-800"></div>

            {/* User marker */}
            {userLocation && (
              <div className="absolute top-1/2 left-1/2 transform -translate-x-1
