<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactical System PRO</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body, html { margin:0; padding:0; height:100%; overflow:hidden; font-family:system-ui,-apple-system; }
  #root { width:100%; height:100%; }
  .menu-right { position: absolute; top:0; right:0; height:100%; width:250px; background:rgba(31,41,55,0.95); color:white; z-index:50; padding:10px; overflow-y:auto; }
  .map-container { position: absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(to bottom, #064e3b, #047857); }
  .marker { position:absolute; transform:translate(-50%,-50%); cursor:pointer; }
  .tooltip { position:absolute; background:rgba(0,0,0,0.7); color:white; padding:2px 6px; border-radius:4px; font-size:12px; pointer-events:none; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

const storage = {
  get: (k) => { try { return JSON.parse(localStorage.getItem(k)) || null; } catch { return null; } },
  set: (k,v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch{} }
};

const TacticalApp = () => {
  // Stati principali
  const [userLocation, setUserLocation] = useState(null);
  const [markers, setMarkers] = useState([]);
  const [measurePoints, setMeasurePoints] = useState([]);
  const [selectedMarker, setSelectedMarker] = useState(null);
  const [pointer, setPointer] = useState(null);
  const [markerSize, setMarkerSize] = useState(24);

  const [showMenu, setShowMenu] = useState(true);
  const [coordFormat, setCoordFormat] = useState('DD');

  const watchRef = useRef(null);

  const markerTypes = { waypoint:'üìç', objective:'üéØ', observation:'üëÅÔ∏è', hazard:'‚ö†Ô∏è' };

  // GPS live
  useEffect(() => {
    if('geolocation' in navigator){
      watchRef.current = navigator.geolocation.watchPosition(pos=>{
        setUserLocation({lat:pos.coords.latitude,lng:pos.coords.longitude});
      });
    }
    return ()=>{ if(watchRef.current) navigator.geolocation.clearWatch(watchRef.current); };
  },[]);

  // Funzioni coordinate
  const formatCoordinates = (lat,lng) => {
    switch(coordFormat){
      case 'DMS':{
        const dms = (deg,isLat)=>{
          const abs = Math.abs(deg); const d = Math.floor(abs); const m = Math.floor((abs-d)*60);
          const s = ((abs-d-m/60)*3600).toFixed(2);
          const dir = deg>=0?(isLat?'N':'E'):(isLat?'S':'W');
          return `${d}¬∞${m}'${s}" ${dir}`;
        };
        return dms(lat,true)+' '+dms(lng,false);
      }
      case 'DD': return lat.toFixed(6)+', '+lng.toFixed(6);
      default: return lat.toFixed(6)+', '+lng.toFixed(6);
    }
  };

  const handleMapClick = (e) => {
    const rect = e.target.getBoundingClientRect();
    const x = ((e.clientX-rect.left)/rect.width)*100;
    const y = ((e.clientY-rect.top)/rect.height)*100;
    const lat = userLocation ? userLocation.lat + (y-50)/100 : 0;
    const lng = userLocation ? userLocation.lng + (x-50)/100 : 0;
    setPointer({lat,lng,x,y});
  };

  const addMarker = () => {
    if(pointer){
      setMarkers([...markers,{id:Date.now(),lat:pointer.lat,lng:pointer.lng,type:'waypoint'}]);
    }
  };

  const calculateDistance = (lat1,lng1,lat2,lng2) => {
    const R = 6371000; const œÜ1=lat1*Math.PI/180; const œÜ2=lat2*Math.PI/180;
    const ŒîœÜ=(lat2-lat1)*Math.PI/180; const ŒîŒª=(lng2-lng1)*Math.PI/180;
    const a = Math.sin(ŒîœÜ/2)**2 + Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(ŒîŒª/2)**2;
    const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
  };

  return (
    <div className="h-full w-full relative">
      <div className="map-container" onClick={handleMapClick}></div>

      {/* Marker */}
      {markers.map((m,i)=>(
        <div key={m.id} className="marker" style={{top:`${50+i*5}%`,left:`${50+i*5}%`,fontSize:markerSize+'px'}}
          onClick={()=>setSelectedMarker(m)}>
          {markerTypes[m.type] || 'üìç'}
        </div>
      ))}

      {/* Pointer */}
      {pointer && (
        <div className="marker" style={{top:`${pointer.y}%`,left:`${pointer.x}%`,fontSize:markerSize+'px'}}>
          üìå
          <div className="tooltip">{formatCoordinates(pointer.lat,pointer.lng)}</div>
        </div>
      )}

      {/* Right Menu */}
      {showMenu && (
        <div className="menu-right">
          <h2 className="text-lg font-bold mb-2">Tools</h2>
          <button className="w-full p-2 mb-2 bg-gray-700 rounded" onClick={addMarker}>Aggiungi Marker</button>
          <div className="mb-2">
            <label>Formato coordinate:</label>
            <select className="w-full p-1 rounded mt-1" value={coordFormat} onChange={e=>setCoordFormat(e.target.value)}>
              <option value="DD">DD</option>
              <option value="DMS">DMS</option>
            </select>
          </div>
          <div className="mb-2">
            <label>Dimensione marker:</label>
            <input type="range" min="12" max="48" value={markerSize} onChange={e=>setMarkerSize(e.target.value)} className="w-full"/>
          </div>
          {selectedMarker && (
            <div className="mt-2 p-2 bg-gray-600 rounded">
              <h3 className="font-bold text-sm">Info Marker</h3>
              <p>ID: {selectedMarker.id}</p>
              <p>Lat,Lon: {formatCoordinates(selectedMarker.lat,selectedMarker.lng)}</p>
              <p>Tipo: {selectedMarker.type}</p>
            </div>
          )}
          {pointer && (
            <div className="mt-2 p-2 bg-gray-600 rounded">
              <h3 className="font-bold text-sm">Puntatore</h3>
              <p>{formatCoordinates(pointer.lat,pointer.lng)}</p>
              {userLocation && <p>Distanza: {Math.round(calculateDistance(userLocation.lat,userLocation.lng,pointer.lat,pointer.lng))} m</p>}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

ReactDOM.render(<TacticalApp />,document.getElementById('root'));
</script>
</body>
</html>
