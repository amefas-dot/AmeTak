<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactical System PRO</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  html, body, #map { height: 100%; margin:0; padding:0; }
</style>
</head>
<body>
<div id="map"></div>

<script>
let map = L.map('map').setView([45.0, 12.0], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let userMarker = null;
let breadcrumbs = [];
let breadcrumbLayer = L.layerGroup().addTo(map);
let markers = [];
let areas = [];
let areaLayer = L.layerGroup().addTo(map);
let drawingArea = false;
let areaPoints = [];

// GPS tracking
if (navigator.geolocation) {
  navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    if (!userMarker) {
      userMarker = L.circleMarker([lat,lng], {radius:6, color:'blue'}).addTo(map);
      map.setView([lat,lng], 16);
    } else {
      userMarker.setLatLng([lat,lng]);
    }

    breadcrumbs.push([lat,lng]);
    if (breadcrumbs.length > 100) breadcrumbs.shift();
    breadcrumbLayer.clearLayers();
    breadcrumbs.forEach(p => L.circleMarker(p, {radius:4,color:'cyan'}).addTo(breadcrumbLayer));

  }, err => alert('Errore GPS: '+err.message), {enableHighAccuracy:true});
}

// Add marker at current position
function addMarker(type='waypoint') {
  if (!userMarker) return;
  const latlng = userMarker.getLatLng();
  const iconMap = {
    waypoint:'üìç',
    hazard:'‚ö†Ô∏è'
  };
  const m = L.marker(latlng, {
    title:type
  }).bindPopup(iconMap[type] + ' ' + type).addTo(map);
  markers.push(m);
}

// Toggle area drawing
function toggleArea() { drawingArea=!drawingArea; if(!drawingArea) areaPoints=[]; }

// Complete area
function completeArea() {
  if(areaPoints.length<3) return alert('Serve almeno 3 punti');
  const polygon = L.polygon(areaPoints, {color:'yellow',fillOpacity:0.2}).addTo(areaLayer);
  areas.push(polygon);
  areaPoints = [];
  drawingArea=false;
}

// Click on map for area points
map.on('click', e=>{
  if(drawingArea) {
    areaPoints.push([e.latlng.lat,e.latlng.lng]);
    L.circleMarker(e.latlng,{radius:4,color:'yellow'}).addTo(areaLayer);
  }
});

// Simple layer toggle
function toggleLayer(layerName){
  if(layerName==='markers') markers.forEach(m => map.hasLayer(m)?map.removeLayer(m):m.addTo(map));
  if(layerName==='breadcrumbs') map.hasLayer(breadcrumbLayer)?map.removeLayer(breadcrumbLayer):breadcrumbLayer.addTo(map);
  if(layerName==='areas') map.hasLayer(areaLayer)?map.removeLayer(areaLayer):areaLayer.addTo(map);
}

// Simple chat simulation
let chatMessages = [];
function addChat(msg){
  chatMessages.push(msg);
  console.log('CHAT:', msg);
}

// Controls
L.control.custom = L.Control.extend({
  onAdd: function(map){
    const div = L.DomUtil.create('div','bg-gray-800 p-2 rounded text-white');
    div.innerHTML = `
      <button onclick="addMarker('waypoint')" class="block m-1 bg-blue-600 p-1 rounded w-full">üìç Waypoint</button>
      <button onclick="addMarker('hazard')" class="block m-1 bg-red-600 p-1 rounded w-full">‚ö†Ô∏è Hazard</button>
      <button onclick="toggleArea()" class="block m-1 bg-green-600 p-1 rounded w-full">üî∑ Disegna Area</button>
      <button onclick="completeArea()" class="block m-1 bg-yellow-600 p-1 rounded w-full">‚úÖ Completa Area</button>
      <button onclick="toggleLayer('markers')" class="block m-1 bg-gray-400 p-1 rounded w-full text-black">Toggle Markers</button>
      <button onclick="toggleLayer('breadcrumbs')" class="block m-1 bg-gray-400 p-1 rounded w-full text-black">Toggle Breadcrumbs</button>
      <button onclick="toggleLayer('areas')" class="block m-1 bg-gray-400 p-1 rounded w-full text-black">Toggle Aree</button>
      <button onclick="addChat('Messaggio Test')" class="block m-1 bg-gray-500 p-1 rounded w-full text-black">üí¨ Chat</button>
    `;
    return div;
  }, onRemove: function(map){}
});
(new L.control.custom({position:'topright'})).addTo(map);
</script>
</body>
</html>
