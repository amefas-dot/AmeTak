<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactical System PRO</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  html, body { height:100%; margin:0; }
  #map { height:100%; width:100%; }
  #toolsMenu {
    position:absolute; top:10px; right:10px; z-index:1000;
    background:rgba(31,41,55,0.95); color:white; padding:10px;
    border-radius:8px; max-height:90vh; overflow-y:auto; width:220px;
    transition:width 0.3s;
  }
  #toolsMenu.collapsed { width:40px; overflow:hidden; }
  #toolsMenu h2 { cursor:pointer; margin-bottom:8px; }
  #toolsMenu button { width:100%; margin-bottom:4px; text-align:left; }
  #pointerInfo { margin-top:4px; font-size:12px; }
  #myPosBtn {
    position:absolute; bottom:20px; right:20px; z-index:1000;
    background:#2563eb; color:white; padding:10px; border-radius:50%;
    cursor:pointer; display:flex; flex-direction:column; align-items:center;
    justify-content:center;
  }
  #myPosCoords { font-size:12px; color:white; margin-top:4px; text-align:center; }
</style>
</head>
<body>
<div id="map"></div>
<div id="toolsMenu">
  <h2 id="menuToggle">TOOLS ☰</h2>
  <div id="menuContent">
    <button id="addMarkerBtn" class="bg-blue-600 p-2 rounded">📍 Aggiungi Marker</button>
    <button id="drawAreaBtn" class="bg-purple-600 p-2 rounded">🔷 Disegna Area</button>
    <button id="measureBtn" class="bg-green-600 p-2 rounded">📏 Misura Distanza</button>
    <button id="toggleBreadcrumbsBtn" class="bg-yellow-600 p-2 rounded">🛤️ Mostra Traccia</button>
    <button id="exportBtn" class="bg-gray-600 p-2 rounded">💾 Esporta Dati</button>
    <div id="pointerInfo"></div>
  </div>
</div>
<div id="myPosBtn">
  <div>📌</div>
  <div id="myPosCoords">-- , --</div>
</div>

<script>
// --- Setup mappa ---
const map = L.map('map').setView([45.4642, 9.19], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap', maxZoom:19 }).addTo(map);

// --- Layer groups ---
const markersLayer = L.layerGroup().addTo(map);
const areasLayer = L.layerGroup().addTo(map);
const breadcrumbsLayer = L.layerGroup().addTo(map);
const measureLayer = L.layerGroup().addTo(map);

// --- Storage ---
let markers = [], areas = [], breadcrumbs = [], measurePoints = [];
let drawingArea=false;

// --- Coordinate formats ---
function formatDD(lat,lng){ return `${lat.toFixed(6)}, ${lng.toFixed(6)}`; }
function formatDM(lat,lng){
  const toDM = deg => { const d=Math.floor(deg); const m=(deg-d)*60; return `${d}° ${m.toFixed(4)}'`; };
  return `${toDM(lat)} N/S, ${toDM(lng)} E/W`;
}
function formatDMS(lat,lng){
  const toDMS = deg => {
    const d=Math.floor(deg);
    const m=Math.floor((deg-d)*60);
    const s=((deg-d-m/60)*3600).toFixed(2);
    return `${d}°${m}'${s}"`;
  };
  return `${toDMS(lat)} N/S, ${toDMS(lng)} E/W`;
}
function toUTM(lat,lng){
  // semplificato, solo per esempio
  const zone = Math.floor((lng+180)/6)+1;
  return `UTM Zone ${zone} (${lat.toFixed(2)},${lng.toFixed(2)})`;
}
function toMGRS(lat,lng){ return `MGRS (${lat.toFixed(2)},${lng.toFixed(2)})`; }

// --- Distance and bearing ---
function calculateDistance(lat1,lon1,lat2,lon2){
  const R=6371000;
  const φ1 = lat1*Math.PI/180, φ2=lat2*Math.PI/180;
  const Δφ=(lat2-lat1)*Math.PI/180, Δλ=(lon2-lon1)*Math.PI/180;
  const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}
function calculateBearing(lat1,lon1,lat2,lon2){
  const φ1 = lat1*Math.PI/180, φ2=lat2*Math.PI/180;
  const Δλ=(lon2-lon1)*Math.PI/180;
  const y=Math.sin(Δλ)*Math.cos(φ2);
  const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

// --- Menù toggle ---
document.getElementById('menuToggle').onclick = () => {
  document.getElementById('toolsMenu').classList.toggle('collapsed');
};

// --- Puntatore ---
map.on('mousemove', (e)=>{
  const lat=e.latlng.lat, lng=e.latlng.lng;
  document.getElementById('pointerInfo').innerHTML = `<b>Mouse:</b> DD: ${formatDD(lat,lng)}<br>DM: ${formatDM(lat,lng)}<br>DMS: ${formatDMS(lat,lng)}<br>UTM: ${toUTM(lat,lng)}<br>MGRS: ${toMGRS(lat,lng)}`;
});

// --- Pulsante posizione ---
const myPosBtn = document.getElementById('myPosBtn');
const myPosCoords = document.getElementById('myPosCoords');
let userMarker=null;
function updateUserPosition(pos){
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;
  myPosCoords.innerText = formatDD(lat,lng);
  if(userMarker) userMarker.setLatLng([lat,lng]);
  else userMarker=L.marker([lat,lng],{title:"Tua Posizione"}).addTo(map);
}
navigator.geolocation.watchPosition(updateUserPosition);

// --- Tools ---
document.getElementById('addMarkerBtn').onclick=()=>{
  map.once('click',(e)=>{
    const popupContent = `📍<br>DD: ${formatDD(e.latlng.lat,e.latlng.lng)}<br>DM: ${formatDM(e.latlng.lat,e.latlng.lng)}<br>DMS: ${formatDMS(e.latlng.lat,e.latlng.lng)}<br>UTM: ${toUTM(e.latlng.lat,e.latlng.lng)}<br>MGRS: ${toMGRS(e.latlng.lat,e.latlng.lng)}`;
    L.marker([e.latlng.lat,e.latlng.lng]).addTo(markersLayer).bindPopup(popupContent);
    markers.push({lat:e.latlng.lat,lng:e.latlng.lng});
  });
};
document.getElementById('drawAreaBtn').onclick=()=>{
  drawingArea=true; let areaPoints=[];
  map.on('click', function f(e){
    areaPoints.push([e.latlng.lat,e.latlng.lng]);
    if(areaPoints.length>=3){
      L.polygon(areaPoints,{color:'purple',fillOpacity:0.2}).addTo(areasLayer);
      areas.push(areaPoints);
      map.off('click',f); drawingArea=false;
    }
  });
};
document.getElementById('measureBtn').onclick=()=>{
  measurePoints=[]; measureLayer.clearLayers();
  map.once('click',(e)=>{ 
    measurePoints.push([e.latlng.lat,e.latlng.lng]); 
    L.circleMarker([e.latlng.lat,e.latlng.lng],{radius:4,color:'green'}).addTo(measureLayer); 
  });
};
document.getElementById('toggleBreadcrumbsBtn').onclick=()=>{
  breadcrumbsLayer.clearLayers();
  breadcrumbs.forEach(p=>L.circleMarker([p.lat,p.lng],{radius:3,color:'yellow'}).addTo(breadcrumbsLayer));
};
</script>
</body>
</html>
