<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactical System PRO</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
html, body, #root { margin:0; padding:0; height:100%; width:100%; font-family:system-ui; }
.leaflet-container { height: 100%; width: 100%; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

// Marker types
const markerTypes = {
  waypoint: { icon: 'ğŸ“', color: '#3b82f6' },
  objective: { icon: 'ğŸ¯', color: '#ef4444' },
  observation: { icon: 'ğŸ‘ï¸', color: '#10b981' },
  hazard: { icon: 'âš ï¸', color: '#f59e0b' },
  friendly: { icon: 'ğŸ”µ', color: '#06b6d4' },
  hostile: { icon: 'ğŸ”´', color: '#dc2626' },
  unknown: { icon: 'â“', color: '#6b7280' },
  medic: { icon: 'ğŸ¥', color: '#ef4444' },
  supply: { icon: 'ğŸ“¦', color: '#8b5cf6' },
  lz: { icon: 'ğŸš', color: '#22c55e' }
};

// Coordinate formats
function formatCoordinates(lat, lng, format='dd') {
  switch(format) {
    case 'dd': return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    case 'dms':
      const deg2dms = (d, isLat)=>{
        const abs = Math.abs(d);
        const deg = Math.floor(abs);
        const min = Math.floor((abs - deg) * 60);
        const sec = ((abs - deg - min/60) * 3600).toFixed(2);
        const dir = d>=0 ? (isLat?'N':'E'):(isLat?'S':'W');
        return `${deg}Â°${min}'${sec}" ${dir}`;
      };
      return `${deg2dms(lat,true)} ${deg2dms(lng,false)}`;
    default: return `${lat}, ${lng}`;
  }
}

// Distance between points in meters
function calculateDistance(lat1,lng1,lat2,lng2){
  const R=6371000;
  const Ï†1 = lat1 * Math.PI/180;
  const Ï†2 = lat2 * Math.PI/180;
  const Î”Ï† = (lat2-lat1) * Math.PI/180;
  const Î”Î» = (lng2-lng1) * Math.PI/180;
  const a=Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

// Main App
const TacticalApp = () => {
  const [userLocation,setUserLocation] = useState(null);
  const [markers,setMarkers] = useState([]);
  const [breadcrumbs,setBreadcrumbs] = useState([]);
  const [areas,setAreas] = useState([]);
  const [chat,setChat] = useState([]);
  const [activeLayers,setActiveLayers] = useState({markers:true,breadcrumbs:true,areas:true});
  const [drawingArea,setDrawingArea] = useState(false);
  const [areaPoints,setAreaPoints] = useState([]);
  const [coordFormat,setCoordFormat] = useState('dd');
  const mapRef = useRef(null);
  const currentUser = {id:'user_'+Date.now(),callsign:'ALPHA-1'};

  // Init map
  useEffect(()=>{
    mapRef.current = L.map('map',{zoomControl:true});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM'}).addTo(mapRef.current);
  },[]);

  // GPS tracking
  useEffect(()=>{
    if(!navigator.geolocation) return;
    const watchId = navigator.geolocation.watchPosition(pos=>{
      const loc = {lat:pos.coords.latitude,lng:pos.coords.longitude};
      setUserLocation(loc);
      setBreadcrumbs(prev=>[...prev,loc].slice(-100));
      if(mapRef.current) mapRef.current.setView(loc,mapRef.current.getZoom()||16);
    },err=>console.error(err),{enableHighAccuracy:true});
    return ()=>navigator.geolocation.clearWatch(watchId);
  },[]);

  // Add marker
  const addMarker = (type='waypoint')=>{
    if(!userLocation) return;
    const m = {...userLocation,id:Date.now(),type};
    setMarkers([...markers,m]);
    setChat([...chat,{text:`ğŸ“ Marker aggiunto: ${type}`}]);
  };

  // Map click for area drawing
  const handleMapClick = (e)=>{
    if(drawingArea) setAreaPoints([...areaPoints,e.latlng]);
  };
  const completeArea = ()=>{
    if(areaPoints.length>=3){
      setAreas([...areas,{id:Date.now(),points:areaPoints,name:`Area ${areas.length+1}`}]);
      setAreaPoints([]); setDrawingArea(false);
      setChat([...chat,{text:`ğŸ”· Area creata`}]);
    }
  };

  // Export JSON
  const exportJSON = ()=>{
    const data={markers,breadcrumbs,areas};
    const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download=`tactical_${Date.now()}.json`;a.click();
  };

  // Render layers on map
  useEffect(()=>{
    if(!mapRef.current) return;
    mapRef.current.eachLayer(l=>{if(l.options&&l.options.pane==='overlayPane') mapRef.current.removeLayer(l);});
    if(activeLayers.markers) markers.forEach(m=>{
      const icon=L.divIcon({className:'',html:`<span style="font-size:24px">${markerTypes[m.type].icon}</span>`});
      L.marker([m.lat,m.lng],{icon}).addTo(mapRef.current);
    });
    if(activeLayers.breadcrumbs) breadcrumbs.forEach(p=>L.circleMarker([p.lat,p.lng],{radius:4,color:'cyan',opacity:0.5}).addTo(mapRef.current));
    if(activeLayers.areas) areas.forEach(a=>{
      const latlngs=a.points.map(p=>[p.lat,p.lng]);
      L.polygon(latlngs,{color:'yellow',fillOpacity:0.1}).addTo(mapRef.current);
    });
  },[markers,breadcrumbs,areas,activeLayers]);

  return (
    <div className="h-full w-full relative flex flex-col">
      <div id="map" className="flex-1" onClick={handleMapClick}></div>

      {/* Controls */}
      <div className="absolute top-2 left-2 bg-gray-800 bg-opacity-80 p-2 rounded space-y-1 text-xs">
        <button className="bg-blue-600 p-1 rounded text-white w-full" onClick={()=>addMarker('waypoint')}>ğŸ“ Waypoint</button>
        <button className="bg-red-600 p-1 rounded text-white w-full" onClick={()=>addMarker('hazard')}>âš ï¸ Hazard</button>
        <button className="bg-green-600 p-1 rounded text-white w-full" onClick={()=>setDrawingArea(!drawingArea)}>
          {drawingArea?'âœ• Cancella Disegno':'ğŸ”· Disegna Area'}
        </button>
        {drawingArea && <button className="bg-yellow-600 p-1 rounded text-white w-full" onClick={completeArea}>âœ… Completa Area</button>}
        <button className="bg-gray-400 p-1 rounded w-full text-black" onClick={()=>setActiveLayers({...activeLayers,markers:!activeLayers.markers})}>
          {activeLayers.markers?'Nascondi Markers':'Mostra Markers'}
        </button>
        <button className="bg-gray-400 p-1 rounded w-full text-black" onClick={exportJSON}>ğŸ’¾ Export JSON</button>
        <button className="bg-gray-400 p-1 rounded w-full text-black" onClick={()=>setCoordFormat(coordFormat==='dd'?'dms':'dd')}>
          {coordFormat==='dd'?'Mostra DMS':'Mostra DD'}
        </button>
      </div>

      {/* Chat */}
      <div className="absolute bottom-2 left-2 w-72 max-h-48 overflow-y-auto bg-gray-800 bg-opacity-90 p-2 rounded text-xs space-y-1">
        {chat.map((m,i)=><div key={i}>{m.text}</div>)}
      </div>
    </div>
  );
