<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactical System PRO</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.5/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.5/dist/leaflet.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
<style>
  html, body, #map { height: 100%; margin: 0; padding: 0; }
  .menu { position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(30,30,30,0.9); color: white; padding: 1rem; border-radius: 0.5rem; max-width: 300px; }
  .menu h2 { font-weight: bold; margin-bottom: 0.5rem; }
  .menu label { display: block; margin-top: 0.5rem; }
</style>
</head>
<body>

<div id="map"></div>

<div class="menu">
  <h2>Tools</h2>
  
  <label>Icon size:
    <input type="range" id="iconSize" min="20" max="80" value="40">
  </label>
  
  <button id="addMarkerBtn" class="mt-2 p-2 bg-blue-600 rounded w-full">Aggiungi Marker</button>
  <button id="clearMarkersBtn" class="mt-2 p-2 bg-red-600 rounded w-full">Rimuovi tutti i Marker</button>
  
  <div class="mt-4">
    <h3 class="font-bold mb-1">Seleziona punto:</h3>
    <div id="pointerInfo">Clicca sulla mappa per vedere info</div>
  </div>
  
  <div class="mt-4">
    <h3 class="font-bold mb-1">Formato Coordinate:</h3>
    <select id="coordFormat" class="w-full bg-gray-800 text-white rounded p-1">
      <option value="dd">DD (lat/lon decimale)</option>
      <option value="dms">DMS</option>
      <option value="dm">DM</option>
      <option value="utm">UTM</option>
      <option value="mgrs">MGRS</option>
    </select>
  </div>

  <div class="mt-4">
    <h3 class="font-bold mb-1">Distanza e Direzione:</h3>
    <div id="distanceInfo">Seleziona due punti sulla mappa</div>
  </div>
</div>

<script>
// Inizializza mappa
const map = L.map('map').setView([45.0, 12.0], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

// Storage
let markers = [];
let markerGroup = L.layerGroup().addTo(map);
let iconSize = 40;
let coordFormat = 'dd';
let distancePoints = [];

// Coordinate formats
function formatCoordinate(lat, lon) {
  switch(coordFormat) {
    case 'dd': return `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    case 'dms': {
      function toDMS(deg) {
        const d = Math.floor(Math.abs(deg));
        const m = Math.floor((Math.abs(deg) - d)*60);
        const s = ((Math.abs(deg) - d - m/60)*3600).toFixed(2);
        const dir = deg >=0 ? (deg===lat?'N':'E') : (deg===lat?'S':'W');
        return `${d}°${m}'${s}"${dir}`;
      }
      return `${toDMS(lat)}, ${toDMS(lon)}`;
    }
    case 'dm': {
      function toDM(deg) {
        const d = Math.floor(Math.abs(deg));
        const m = ((Math.abs(deg) - d)*60).toFixed(4);
        const dir = deg >=0 ? (deg===lat?'N':'E') : (deg===lat?'S':'W');
        return `${d}°${m}'${dir}`;
      }
      return `${toDM(lat)}, ${toDM(lon)}`;
    }
    // UTM and MGRS can be added with libraries if needed
    default: return `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
  }
}

// Pulsante Aggiungi Marker
document.getElementById('addMarkerBtn').addEventListener('click', () => {
  map.once('click', e => {
    const marker = L.marker(e.latlng, {
      icon: L.divIcon({ className: 'text-2xl', html: '📍', iconSize: [iconSize, iconSize] })
    }).addTo(markerGroup);
    markers.push(marker);
  });
});

// Clear markers
document.getElementById('clearMarkersBtn').addEventListener('click', () => {
  markerGroup.clearLayers();
  markers = [];
  distancePoints = [];
  document.getElementById('distanceInfo').innerText = "Seleziona due punti sulla mappa";
});

// Icon size slider
document.getElementById('iconSize').addEventListener('input', (e) => {
  iconSize = e.target.value;
  markers.forEach(m => {
    m.setIcon(L.divIcon({ className: 'text-2xl', html: '📍', iconSize: [iconSize, iconSize] }));
  });
});

// Coordinate format select
document.getElementById('coordFormat').addEventListener('change', (e) => {
  coordFormat = e.target.value;
});

// Selezione punti per info
map.on('click', e => {
  const lat = e.latlng.lat;
  const lng = e.latlng.lng;
  document.getElementById('pointerInfo').innerText = `Coordinate: ${formatCoordinate(lat, lng)}`;
  
  distancePoints.push([lat,lng]);
  if(distancePoints.length === 2){
    const [p1, p2] = distancePoints;
    const R = 6371000; // metri
    const φ1 = p1[0]*Math.PI/180;
    const φ2 = p2[0]*Math.PI/180;
    const Δφ = (p2[0]-p1[0])*Math.PI/180;
    const Δλ = (p2[1]-p1[1])*Math.PI/180;
    const a = Math.sin(Δφ/2)*Math.sin(Δφ/2)+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R*c;
    
    const y = Math.sin(Δλ)*Math.cos(φ2);
    const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
    const bearing = (Math.atan2(y,x)*180/Math.PI+360)%360;
    
    document.getElementById('distanceInfo').innerText = `Distanza: ${distance.toFixed(1)} m, Direzione: ${bearing.toFixed(1)}°`;
    distancePoints = [];
  }
});

</script>
</body>
</html>
