<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactical System PRO</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
<script src="https://cdn.jsdelivr.net/npm/utm-latlng@1.0.0/utm.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  html, body { height:100%; margin:0; }
  #map { height:100%; width:100%; }
  #toolsMenu { position:absolute; top:10px; right:10px; z-index:1000; background:rgba(31,41,55,0.95); color:white; padding:10px; border-radius:8px; max-height:90vh; overflow-y:auto; width:200px; }
  #toolsMenu button { width:100%; margin-bottom:4px; }
  .popup-content { font-size:12px; }
</style>
</head>
<body>
<div id="map"></div>
<div id="toolsMenu">
  <h2 class="font-bold mb-2">TOOLS</h2>
  <button id="addMarkerBtn" class="bg-blue-600 p-2 rounded mb-1">ğŸ“ Aggiungi Marker</button>
  <button id="drawAreaBtn" class="bg-purple-600 p-2 rounded mb-1">ğŸ”· Disegna Area</button>
  <button id="measureBtn" class="bg-green-600 p-2 rounded mb-1">ğŸ“ Misura Distanza</button>
  <button id="toggleBreadcrumbsBtn" class="bg-yellow-600 p-2 rounded mb-1">ğŸ›¤ï¸ Mostra Traccia</button>
  <button id="exportBtn" class="bg-gray-600 p-2 rounded mb-1">ğŸ’¾ Esporta Dati</button>
  <div id="pointerInfo" class="mt-2 p-2 bg-gray-700 rounded text-xs"></div>
</div>

<script>
// --- Setup Mappa ---
const map = L.map('map').setView([45.4642, 9.19], 13); // Milano
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'Â© OpenStreetMap', maxZoom:19
}).addTo(map);

// --- Storage ---
const storage = { get:(k)=>JSON.parse(localStorage.getItem(k)||'[]'), set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)) };

// --- Stati ---
let markers = storage.get('markers');
let areas = storage.get('areas');
let breadcrumbs = storage.get('breadcrumbs');
let measurePoints = [];
let drawingArea = false;

// --- Layer groups ---
const markersLayer = L.layerGroup().addTo(map);
const areasLayer = L.layerGroup().addTo(map);
const breadcrumbsLayer = L.layerGroup().addTo(map);
const measureLayer = L.layerGroup().addTo(map);

// --- Coordinate formats ---
function formatDD(lat,lng){ return `${lat.toFixed(6)}, ${lng.toFixed(6)}`; }
function formatDMS(lat,lng){
  const dms=(deg,isLat)=>{const abs=Math.abs(deg);const d=Math.floor(abs);const m=Math.floor((abs-d)*60);const s=((abs-d-m/60)*3600).toFixed(2);const dir=deg>=0?(isLat?'N':'E'):(isLat?'S':'W'); return `${d}Â°${m}'${s}" ${dir}`;};
  return `${dms(lat,true)} ${dms(lng,false)}`;
}
function formatDM(lat,lng){const dm=(deg,isLat)=>{const abs=Math.abs(deg);const d=Math.floor(abs);const m=((abs-d)*60).toFixed(4);const dir=deg>=0?(isLat?'N':'E'):(isLat?'S':'W');return `${d}Â° ${m}' ${dir}`;}; return `${dm(lat,true)} ${dm(lng,false)}`;}

// UTM/MGRS con utm-latlng
const utmObj = new UTMLatLng();
function formatUTM(lat,lng){ const z=utmObj.convertLatLngToUtm(lat,lng); return `Zone ${z.zoneNum}${z.zoneLetter} ${Math.round(z.easting)}mE ${Math.round(z.northing)}mN`; }
function formatMGRS(lat,lng){ return utmObj.convertLatLngToMGRS(lat,lng); }

// Calcolo direzione tra due punti
function calculateBearing(lat1,lng1,lat2,lng2){
  const Ï†1 = lat1*Math.PI/180;
  const Ï†2 = lat2*Math.PI/180;
  const Î”Î» = (lng2-lng1)*Math.PI/180;
  const y = Math.sin(Î”Î»)*Math.cos(Ï†2);
  const x = Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
  let Î¸ = Math.atan2(y,x)*180/Math.PI;
  return (Î¸+360)%360;
}

// Popup completo
function showCoords(lat,lng,lat2,lng2){
  let popup=`<b>DD:</b>${formatDD(lat,lng)}<br>
  <b>DMS:</b>${formatDMS(lat,lng)}<br>
  <b>DM:</b>${formatDM(lat,lng)}<br>
  <b>UTM:</b>${formatUTM(lat,lng)}<br>
  <b>MGRS:</b>${formatMGRS(lat,lng)}`;
  if(lat2!==undefined && lng2!==undefined){
    const dist=map.distance([lat,lng],[lat2,lng2]);
    const bearing=calculateBearing(lat,lng,lat2,lng2);
    popup+=`<br><b>Distanza:</b> ${dist.toFixed(2)} m<br><b>Direzione:</b> ${bearing.toFixed(1)}Â°`;
  }
  return popup;
}

// --- Funzioni ---
function addMarker(lat,lng,title="Marker",size=32,lat2,lng2){
  const icon = L.divIcon({className:'custom-icon', html:`<div style="font-size:${size}px">ğŸ“</div>`});
  const m = L.marker([lat,lng],{icon}).bindPopup(showCoords(lat,lng,lat2,lng2)).addTo(markersLayer);
  markers.push({lat,lng,title});
  storage.set('markers',markers);
}

function addArea(points){
  const poly = L.polygon(points,{color:'purple',fillOpacity:0.2}).bindPopup('Area').addTo(areasLayer);
  areas.push({points});
  storage.set('areas',areas);
}

function addBreadcrumb(lat,lng){
  const c = L.circleMarker([lat,lng],{radius:3,color:'yellow'}).addTo(breadcrumbsLayer);
  breadcrumbs.push({lat,lng});
  storage.set('breadcrumbs',breadcrumbs);
}

function addMeasurePoint(lat,lng){
  measurePoints.push([lat,lng]);
  L.circleMarker([lat,lng],{radius:4,color:'green'}).addTo(measureLayer);
  if(measurePoints.length>1){
    const line=L.polyline(measurePoints,{color:'green'}).addTo(measureLayer);
    const dist=line.getLatLngs().reduce((acc,curr,i,arr)=>i===0?0:acc+map.distance(curr,arr[i-1]),0);
    const bearing=calculateBearing(measurePoints[measurePoints.length-2][0],measurePoints[measurePoints.length-2][1],lat,lng);
    line.bindPopup(`Distanza: ${dist.toFixed(2)} m<br>Direzione: ${bearing.toFixed(1)}Â°`);
  }
}

// --- Puntatore ---
const pointerDiv=document.getElementById('pointerInfo');
map.on('mousemove',(e)=>{ pointerDiv.innerHTML=`<b>Mouse:</b> ${formatDD(e.latlng.lat,e.latlng.lng)}`; });

// --- Eventi menu ---
document.getElementById('addMarkerBtn').onclick=()=>{ map.once('click',(e)=>addMarker(e.latlng.lat,e.latlng.lng,"Marker",32)); };
document.getElementById('drawAreaBtn').onclick=()=>{
  drawingArea=true; let areaPoints=[];
  map.on('click',function f(e){
    areaPoints.push([e.latlng.lat,e.latlng.lng]);
    if(areaPoints.length>=3){ addArea(areaPoints); map.off('click',f); drawingArea=false; }
  });
};
document.getElementById('measureBtn').onclick=()=>{ measurePoints=[]; measureLayer.clearLayers(); map.once('click',(e)=>{ addMeasurePoint(e.latlng.lat,e.latlng.lng); }); };
document.getElementById('toggleBreadcrumbsBtn').onclick=()=>{ if(map.hasLayer(breadcrumbsLayer)) map.removeLayer(breadcrumbsLayer); else map.addLayer(breadcrumbsLayer); };
document.getElementById('exportBtn').onclick=()=>{
  const data={markers,areas,breadcrumbs};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`tactical_${Date.now()}.json`; a.click();
};

// --- Carica dati salvati ---
markers.forEach(m=>addMarker(m.lat,m.lng,m.title));
areas.forEach(a=>addArea(a.points));
breadcrumbs.forEach(b=>addBreadcrumb(b.lat,b.lng));
</script>
</body>
</html>
