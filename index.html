<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactical System PRO</title>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  html, body { height: 100%; margin: 0; font-family: system-ui; }
  #map { height: 100%; width: 100%; }
  .pulse { animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite; }
  @keyframes pulse { 0%,100%{opacity:1;}50%{opacity:0.5;} }
  .animate-spin { animation: spin 1s linear infinite; }
  @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
</style>
</head>
<body class="bg-gray-900 text-white">

<!-- Map -->
<div id="map"></div>

<!-- Header -->
<div class="absolute top-0 left-0 w-full p-2 bg-gray-800 bg-opacity-90 flex justify-between items-center z-50">
  <div>
    <span class="text-xl">🎯 Tactical System PRO</span>
  </div>
  <div id="gpsStatus" class="text-sm">GPS: 🔴 Non rilevato</div>
</div>

<!-- Controls -->
<div class="absolute top-16 left-2 bg-gray-800 bg-opacity-90 p-2 rounded z-50 space-y-2">
  <button id="addMarkerBtn" class="w-full p-2 bg-blue-600 hover:bg-blue-700 rounded">📍 Aggiungi Marker</button>
  <button id="drawAreaBtn" class="w-full p-2 bg-purple-600 hover:bg-purple-700 rounded">🔷 Disegna Area</button>
  <button id="measureBtn" class="w-full p-2 bg-red-600 hover:bg-red-700 rounded">📏 Misura Distanza</button>
  <button id="toggleLayersBtn" class="w-full p-2 bg-green-600 hover:bg-green-700 rounded">📊 Layers</button>
  <button id="chatBtn" class="w-full p-2 bg-yellow-600 hover:bg-yellow-700 rounded">💬 Chat</button>
</div>

<!-- Bottom nav -->
<div class="absolute bottom-0 left-0 w-full bg-gray-800 bg-opacity-90 p-2 flex justify-around z-50">
  <button class="p-2">📍 Mappa</button>
  <button class="p-2">💬 Chat</button>
  <button class="p-2">📊 Layers</button>
  <button class="p-2">👥 Team</button>
  <button class="p-2">☰ Menu</button>
</div>

<script>
const map = L.map('map').setView([45.4642, 9.19], 13); // Milano come esempio

// Tile layer
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

// State
let markers = [];
let areas = [];
let breadcrumbs = [];
let measurePoints = [];
let drawingArea = false;
let measuring = false;

// Current user
const currentUser = { id: 'user_' + Date.now(), name: 'Operatore', callsign: 'ALPHA-1' };

// GPS
const gpsStatus = document.getElementById('gpsStatus');
if ('geolocation' in navigator) {
  navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    gpsStatus.innerText = `GPS: 🟢 Rilevato (${lat.toFixed(5)}, ${lng.toFixed(5)})`;

    // Breadcrumbs
    breadcrumbs.push([lat, lng]);
    if (breadcrumbs.length > 100) breadcrumbs.shift();
  }, err => {
    gpsStatus.innerText = `GPS: ❌ Errore`;
  }, { enableHighAccuracy: true });
}

// Add Marker
document.getElementById('addMarkerBtn').onclick = () => {
  if (!breadcrumbs.length) return alert('GPS non rilevato');
  const latlng = breadcrumbs[breadcrumbs.length-1];
  const marker = L.marker(latlng, { draggable: true }).addTo(map)
    .bindPopup(`<b>Waypoint</b><br>${currentUser.callsign}`);
  markers.push(marker);
};

// Draw Area
document.getElementById('drawAreaBtn').onclick = () => {
  drawingArea = !drawingArea;
  alert(drawingArea ? 'Modalità disegno area attivata' : 'Modalità disegno area disattivata');
  if (drawingArea) {
    let areaPoints = [];
    map.on('click', function onMapClick(e) {
      areaPoints.push([e.latlng.lat, e.latlng.lng]);
      if (areaPoints.length >= 3) {
        const polygon = L.polygon(areaPoints, { color: 'purple', fillOpacity: 0.2 }).addTo(map);
        areas.push(polygon);
        areaPoints = [];
        map.off('click', onMapClick);
        drawingArea = false;
      }
    });
  }
};

// Measure distance
document.getElementById('measureBtn').onclick = () => {
  measuring = !measuring;
  alert(measuring ? 'Modalità misurazione attivata' : 'Modalità misurazione disattivata');
  if (measuring) {
    let points = [];
    map.on('click', function onClick(e) {
      points.push([e.latlng.lat, e.latlng.lng]);
      if (points.length >= 2) {
        const line = L.polyline(points, { color: 'red' }).addTo(map);
        const dist = map.distance(points[0], points[1]);
        alert(`Distanza: ${dist.toFixed(2)} metri`);
        points = [];
        map.off('click', onClick);
        measuring = false;
      }
    });
  }
};

// Chat
document.getElementById('chatBtn').onclick = () => {
  alert('Chat simulata: i messaggi appariranno qui!');
};

// Toggle layers
document.getElementById('toggleLayersBtn').onclick = () => {
  alert('Funzione layers da implementare');
};
</script>
</body>
</html>
