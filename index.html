<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactical System PRO</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- React -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body, #root { height: 100%; margin: 0; padding: 0; }
.leaflet-container { height: 100%; width: 100%; }
.crosshair {
  position: absolute; top: 50%; left: 50%;
  width: 24px; height: 24px; margin-left: -12px; margin-top: -12px;
  pointer-events: none; z-index: 1000; font-size: 24px;
}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

function App() {
  const mapRef = useRef(null);
  const [map, setMap] = useState(null);
  const [userLocation, setUserLocation] = useState(null);
  const [markers, setMarkers] = useState([]);
  const [showMenu, setShowMenu] = useState(false);
  const [coordFormat, setCoordFormat] = useState('DD');

  const markerTypes = {
    waypoint: { icon: 'ðŸ“', size: 30 },
    objective: { icon: 'ðŸŽ¯', size: 30 },
    hazard: { icon: 'âš ï¸', size: 30 }
  };

  useEffect(() => {
    const m = L.map(mapRef.current, { center: [45.4642, 9.19], zoom: 13 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(m);
    setMap(m);
  }, []);

  useEffect(() => {
    if (!map) return;
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const loc = [pos.coords.latitude, pos.coords.longitude];
        setUserLocation(loc);
        map.setView(loc, 16);
        L.circle(loc, { radius: 5, color: 'blue' }).addTo(map);
      });
    }
  }, [map]);

  useEffect(() => {
    if (!map) return;
    const handleClick = e => {
      const m = { id: Date.now(), lat: e.latlng.lat, lng: e.latlng.lng, type: 'waypoint' };
      setMarkers(prev => [...prev, m]);
    };
    map.on('click', handleClick);
    return () => map.off('click', handleClick);
  }, [map]);

  useEffect(() => {
    if (!map) return;
    map.eachLayer(layer => { if(layer.options && layer.options.pane==='markerPane') map.removeLayer(layer) });
    markers.forEach(m => {
      const icon = L.divIcon({ html:`<div style="font-size:${markerTypes[m.type].size}px">${markerTypes[m.type].icon}</div>`, className:'' });
      L.marker([m.lat, m.lng], { icon }).addTo(map).bindPopup(`Lat: ${m.lat.toFixed(6)}, Lng: ${m.lng.toFixed(6)}`);
    });
  }, [markers, map]);

  const formatCoordinates = (lat, lng, fmt) => {
    switch(fmt){
      case 'DD': return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      case 'DMS': 
        const toDMS = d => { const deg=Math.floor(d); const min=Math.floor((d-deg)*60); const sec=((d-deg-min/60)*3600).toFixed(2); return `${deg}Â°${min}'${sec}"`; };
        return `${toDMS(lat)} N, ${toDMS(lng)} E`;
      case 'DM': 
        const toDM = d => { const deg=Math.floor(d); const min=((d-deg)*60).toFixed(4); return `${deg}Â° ${min}'`; };
        return `${toDM(lat)} N, ${toDM(lng)} E`;
      default: return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }
  };

  return (
    <div className="h-full w-full relative">
      <div ref={mapRef} className="leaflet-container"></div>
      <div className="absolute top-2 left-2 z-50">
        <button className="bg-gray-800 text-white p-2 rounded" onClick={()=>setShowMenu(!showMenu)}>â˜° Tools</button>
        {showMenu && (
          <div className="mt-1 bg-gray-700 text-white rounded shadow p-2 space-y-2">
            <button onClick={()=>alert('Marker selezionato')} className="block w-full text-left">Aggiungi Marker</button>
            <button onClick={()=>alert('Misura distanza')} className="block w-full text-left">Misura Distanza</button>
            <button onClick={()=>alert('Esporta dati')} className="block w-full text-left">Esporta KML/GPX/JSON</button>
            <select value={coordFormat} onChange={e=>setCoordFormat(e.target.value)} className="w-full mt-1 text-black">
              <option value="DD">DD</option>
              <option value="DMS">DMS</option>
              <option value="DM">DM</option>
            </select>
          </div>
        )}
      </div>
      <div className="crosshair">ðŸŽ¯</div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
