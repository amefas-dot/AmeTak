<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tactical Map PRO</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  html, body { height: 100%; margin:0; padding:0; font-family:system-ui; overflow:hidden; }
  #map { width:100%; height:100%; z-index:1; }

  /* Header */
  .header { position:absolute; top:0; left:0; right:0; height:50px; background:rgba(31,41,55,0.95); color:white; z-index:1001; display:flex; justify-content:space-between; align-items:center; padding:0 10px; backdrop-filter:blur(10px); }
  .header-left { display:flex; align-items:center; gap:8px; }
  .header-title { font-weight:bold; font-size:14px; }
  .btn { padding:6px 10px; background:#374151; border:none; border-radius:4px; color:white; cursor:pointer; font-size:18px; }
  .btn:hover { background:#4b5563; }

  /* Layer Selector */
  .layer-selector { position:absolute; top:50px; right:10px; background:rgba(31,41,55,0.95); color:white; padding:8px; border-radius:8px; z-index:1000; backdrop-filter:blur(10px); display:none; }
  .layer-selector.open { display:block; }
  .layer-btn { padding:8px 12px; margin:4px 0; width:100%; background:#374151; border:none; color:white; border-radius:4px; cursor:pointer; font-size:12px; }
  .layer-btn.active { background:#10b981; }

  /* GPS Status */
  .gps-status { position:absolute; bottom:20px; left:10px; background:rgba(31,41,55,0.95); color:white; padding:8px 12px; border-radius:8px; font-size:11px; z-index:1000; backdrop-filter:blur(10px); }

  /* Mirino */
  .crosshair { position:absolute; width:32px; height:32px; top:50%; left:50%; margin-left:-16px; margin-top:-16px; z-index:1000; pointer-events:none; }
  .crosshair::before, .crosshair::after { content:''; position:absolute; background:red; }
  .crosshair::before { left:15px; top:0; width:2px; height:32px; }
  .crosshair::after { top:15px; left:0; width:32px; height:2px; }

</style>
</head>
<body>

<div id="map"></div>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <span style="font-size:20px;">üéØ</span>
    <div>
      <div class="header-title">TACTICAL MAP PRO</div>
    </div>
  </div>
  <div style="display:flex; gap:8px;">
    <button class="btn" onclick="toggleLayers()">üó∫Ô∏è</button>
  </div>
</div>

<!-- Layer Selector -->
<div class="layer-selector" id="layerSelector">
  <button class="layer-btn active" onclick="changeMap('street')">Street</button>
  <button class="layer-btn" onclick="changeMap('satellite')">Satellite</button>
  <button class="layer-btn" onclick="changeMap('dark')">Dark</button>
</div>

<!-- GPS Status -->
<div class="gps-status" id="gpsStatus">GPS: Ricerca...</div>

<!-- Mirino -->
<div class="crosshair"></div>

<script>
let map, userMarker, userCircle;
let gpsActive = false;
let currentLayer = 'street';
let tileLayers = {};

// Inizializza mappa
function initMap() {
  map = L.map('map', { zoomControl:true }).setView([41.9028, 12.4964], 6);

  // Tile layers
  tileLayers.street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'¬© OpenStreetMap' }).addTo(map);
  tileLayers.satellite = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom:17, attribution:'¬© OpenTopoMap' });
  tileLayers.dark = L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_dark/{z}/{x}/{y}{r}.png', { maxZoom:20, attribution:'¬© Stadia Maps' });
}

// Cambia layer
function changeMap(layer) {
  if(layer === currentLayer) return;
  map.removeLayer(tileLayers[currentLayer]);
  tileLayers[layer].addTo(map);
  currentLayer = layer;

  // Aggiorna pulsanti
  document.querySelectorAll('.layer-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.layer-btn[onclick*="'+layer+'"]').classList.add('active');

  // Chiudi layer menu
  document.getElementById('layerSelector').classList.remove('open');
}

// Mostra/nascondi menu layer
function toggleLayers() {
  document.getElementById('layerSelector').classList.toggle('open');
}

// Inizializza GPS
function initGPS() {
  if(!navigator.geolocation) {
    document.getElementById('gpsStatus').textContent = 'GPS non supportato';
    return;
  }

  navigator.geolocation.watchPosition(
    pos => {
      gpsActive = true;
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const acc = pos.coords.accuracy;

      document.getElementById('gpsStatus').textContent = `GPS Attivo - Acc: ¬±${Math.round(acc)}m`;

      if(!userMarker) {
        userMarker = L.marker([lat,lng]).addTo(map);
        userCircle = L.circle([lat,lng], { radius: acc, color:'#3b82f6', fillOpacity:0.2 }).addTo(map);
        map.setView([lat,lng],16);
      } else {
        userMarker.setLatLng([lat,lng]);
        userCircle.setLatLng([lat,lng]);
        userCircle.setRadius(acc);
      }
    },
    err => {
      gpsActive = false;
      document.getElementById('gpsStatus').textContent = 'GPS non disponibile';
    },
    { enableHighAccuracy:true, maximumAge:5000 }
  );
}

// Mirino touch
mapClickHandler = (e) => {
  // qui puoi aggiungere un marker temporaneo se vuoi
  console.log("Mirino posizione:", e.latlng.lat, e.latlng.lng);
};

window.onload = () => {
  initMap();
  initGPS();
  map.on('click', mapClickHandler);
};
</script>

</body>
</html>
